Sub compareWithMaster()

' J\Sales\Public\FTP-automation\FTP-\Itemin

' This file is used to compare MASTER vs ITEMin
    ' Left Blank, File Date, Email Receipients
' Log out the differences
' Ex: Wrong file name, missing data in a column(s).

' create system objects for file handling
Set objExcel = CreateObject("Excel.Application")
Set objExcel2 = CreateObject("Excel.Application")

' FOr testing
objExcel.Visible = True
objExcel2.Visible = True



' Log file stuffs - Initially create/clear it
Set objOutput = CreateObject("Scripting.FileSystemObject") ' changed from objFTPOutput to objOutput
logFileName = "C:\Users\ekim\Desktop\Projects\hello\fulltest0.log"
Set logFile = objOutput.CreateTextFile(logFileName, True)
logFile.Write "Datetime of Log Creation: " & Now() & vbCrLf & _
              "-------------------------------------------------------------" & vbCrLf

' path to the excel file
Set objWorkbook = objExcel.Workbooks.Open _
("C:\Users\ekim\Desktop\Projects\hello\ITEMinTest.xlsx")


Set objWorkbook2 = objExcel2.Workbooks.Open _
("C:\Users\ekim\Desktop\Projects\hello\MASTERTEST.xlsx")


' start at the second row, ie, not the column header
intRow = 2

' Below for analysis purpose
intSucess = 0

' loop through each row of the excel file
Do Until objExcel.Cells(intRow, 1).Value = ""
    
' grab the rest of the excel file information
' If the first cell is blank exit the program (SHM)
client = Trim(objExcel.Cells(intRow, 1).Value)
If client = "" Then
    ''''exit do
End If

' Fetch the data to compare it with Master later
file_date = Trim(objExcel.Cells(intRow, 10).Value)
file_left = Trim(objExcel.Cells(intRow, 14).Value)
send_to = Trim(objExcel.Cells(intRow, 1).Value)
email_to = Trim(objExcel.Cells(intRow, 2).Value)
email_cc = Trim(objExcel.Cells(intRow, 3).Value)
email_bcc = Trim(objExcel.Cells(intRow, 4).Value)
file_fullname = Trim(objExcel.Cells(intRow, 9).Value)

Dim dataFound As Boolean
dataFound = False
Dim logFlags As String
Dim logFlags1(5) As String

' Reset for the next line
dataFound = False

' loop against the MASTER file
'''''''''''''' ISSUEEEEEEEEEE: Only gets call for first outer loop
For Each sh In objWorkbook2.Worksheets
    If sh.Index = 1 Then GoTo NextSheet

    ' In each worksheet in MASTER, check each row for the matching record
    For Each rw In sh.Rows
    
        logFlags1(0) = "0"
        logFlags1(1) = "0"
        logFlags1(2) = "0"
        logFlags1(3) = "0"
        logFlags1(4) = "0"
        logFlags1(5) = "0"
        
        Dim keepSearching As Boolean
        keepSearching = False
        
        'If is in Red Highlight, then Ignore this Inactive one
        If rw.Cells(1).Interior.Color = RGB(255, 0, 0) And rw.Cells(2).Interior.Color = RGB(255, 0, 0) Then
            GoTo NextRow
        End If
                
        ' Check further comparison if send_to data matches
        If send_to = rw.Cells(1).Value Then
            
            ' Fetch the data to compare it with Master later
            send_to2 = rw.Cells(1).Value
            file_left2 = rw.Cells(14).Value
            file_date2 = rw.Cells(10).Value
            email_to2 = rw.Cells(2).Value
            email_cc2 = rw.Cells(3).Value
            email_bcc2 = rw.Cells(4).Value
            
            ' Below checks for any failure/unmatched. If so, log this bad boys
            logFlags1(0) = "0" ' Initialize to 0 since we know send_to equals send_to2
            If file_left <> file_left2 Then
                keepSearching = True
                logFlags1(1) = "1"
            End If
            'If file_date <> file_date2 Then keepSearching = True: logFlags1(2) = "1"
            If email_to <> email_to2 Then keepSearching = True: logFlags1(3) = "1"
            If email_cc <> email_cc2 Then keepSearching = True: logFlags1(4) = "1"
            If email_bcc <> email_bcc2 Then keepSearching = True: logFlags1(5) = "1" ': logFile.Write "           Shit: " & sh.Name & "   Row:" & rw.Row & ": " & email_bcc & " || " & email_bcc2

            ' Below checks if a correct record is found in MASTER. If so, log this good too
            If keepSearching = False Then dataFound = True
            If dataFound = True Then
                intSuccess = intSuccess + 1
                Exit For
            End If
            
        Else
            logFlags1(0) = "1"
            logFlags1(1) = "1"
        End If
        
        
NextRow:
        If rw.Row >= 200 Then
            '''''MsgBox "200 reached" + CStr(goNextSheet) + "  " + CStr(dataFound)
            Exit For
        End If
    Next rw
    

NextSheet:
    ' If the matching record is found in MASTER, then we just move to next item in ITEMin file.
    If dataFound = True Then
        Exit For
    End If
    
Next sh

' Logging for Success/Fail
If logFlags1(0) = "1" And logFlags1(1) = "1" Then
    ' Output to Log
    logFile.Write "(" & (intRow - 1) & ") " & send_to & " | " & file_left & vbCrLf & _
                  "     Status: Not Found!" & vbCrLf & _
                  "         Error: Looks like there wasn't a matching record in Master Excel file... Please check again!" & vbCrLf & _
                  "     FAIL" & vbCrLf

    ' Additional details to logs if applicable
    'If logFlags1(2) = "1" Then logFile.Write "      File Date is not matching!" & vbCrLf
    If logFlags1(3) = "1" Then logFile.Write "      CC Email is not matching!" & vbCrLf
    If logFlags1(4) = "1" Then logFile.Write "      BCC Email is not matching!" & vbCrLf
    If logFlags1(5) = "1" Then logFile.Write "      File Fullname is not matching!" & vbCrLf

Else
    ' Output to Log
    logFile.Write "(" & (intRow - 1) & ") " & send_to & " | " & file_left & vbCrLf & _
                  "     Status: Found! " & vbCrLf & _
                  "     Sheet: " & sh.Name & "  Row: " & rw.Row & vbCrLf & _
                  "        Detail below: " & vbCrLf & _
                  "        send_to: " & send_to & vbCrLf & _
                  "        file_left: " & file_left & vbCrLf & _
                  "        email_cc: " & email_cc & vbCrLf & _
                  "        email_bcc: " & email_bcc & vbCrLf & _
                  "        file_date: " & file_date & vbCrLf & _
                  "     SUCCESS!" & vbCrLf
End If

' This coloring is needed for Phase 2 to update Wo0rds
' If the data is NOT found in MASTER file, the row will be fonted in red.
If dataFound = True Then
    objExcel.Range(objExcel.Cells(intRow, 1), objExcel.Cells(intRow, 24)).Font.Color = RGB(0, 0, 0)
    
    ' Since its Word File is updated, we update the MASTER file as well
    objExcel2.Worksheets(sh.Name).Cells(rw.Row, 10).Value = file_date
    objExcel2.Worksheets(sh.Name).Cells(rw.Row, 10).Font.Color = RGB(0, 0, 255) ' Updated is in Blue
    
Else ' Not Found in MASTER -> Change the Font in ITEMin
    objExcel.Range(objExcel.Cells(intRow, 1), objExcel.Cells(intRow, 24)).Font.Color = RGB(255, 0, 0)
End If


' Onto the Next Loop! (Next record in ITEMin)
logFile.Write vbCrLf
intRow = intRow + 1
Loop

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

' Output the Success/Failure Rate to Log File
logFile.Write "Total Record: " & CStr(intRow - 2) & vbCrLf & _
       "Success: " & CStr(intSuccess) & vbCrLf & _
       "Failure: " & CStr(intRow - 2 - intSuccess) & vbCrLf & _
       "*Note: For Successful " & CStr(intSuccess) & " records, Dates will be updated in MASTER File!"
       

' Output the Success/Failure Rate as a Pop-up message
MsgBox "Total Record: " & CStr(intRow - 2) & vbCrLf & _
       "Success: " & CStr(intSuccess) & vbCrLf & _
       "Failure: " & CStr(intRow - 2 - intSuccess)

'objWorkbook.Close
'objExcel.Quit
'objWorkbook2.Close
'objExcel2.Quit

End Sub

